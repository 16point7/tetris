<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Tetris v1.0</title><style>body{font-family:monospace;font-size:12px;background-color:#e8eaf6;color:#1a237e}h1,p{text-align:center}a{text-decoration:none}select{display:block;margin:auto;background-color:rgba(255,255,255,0)}#zone{width:40%;margin:auto}</style></head><body><h1>Tetris</h1><p>v1.0 (<a href="https://github.com/16point7/tetris/tree/v1.0" target="_blank">source</a>)</p><p>n p q ← ↑ → ↓ space</p><select id="levels"></select><div id="zone"></div><script>!function(t){function i(s){if(e[s])return e[s].exports;var h=e[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,i),h.l=!0,h.exports}var e={};i.m=t,i.c=e,i.i=function(t){return t},i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},i.p="",i(i.s=1)}([function(t,i,e){function s(){this.im=new h,this.gm=new o,this.tt=new r,this.cf=n,this.moves=new a(32),this.activeGame,this.loopId,this.prev,this.setup()}var h=e(4).InputManager,o=e(3).GraphicsManager,r=e(7).Tetris,a=e(5).Queue,n=e(2);s.prototype.setup=function(){this.im.setKeyMap(this.cf.keyMap),this.im.register("action",this.action.bind(this)),this.im.register("newgame",this.newGame.bind(this)),this.im.register("quitgame",this.endGame.bind(this)),this.im.register("pausegame",this.pauseGame.bind(this)),this.im.listen(),this.gm.setConfig(this.cf),this.gm.initialize(),this.tt.setConfig(this.cf),this.tt.register("gameover",this.endGame.bind(this)),this.tt.initialize(),this.loop=this.loop.bind(this)},s.prototype.loop=function(t){this.loopId=requestAnimationFrame(this.loop);var i=t-this.prev;this.tt.update(this.moves,i),this.gm.render(this.tt.data,i),this.prev=t},s.prototype.action=function(t){null!=this.loopId&&this.moves.push(t)},s.prototype.newGame=function(){this.activeGame||(this.tt.newState(),this.gm.newState(),this.resetInputQueue(),this.startLoop())},s.prototype.pauseGame=function(){this.activeGame&&(null==this.loopId?this.startLoop():this.endLoop())},s.prototype.endGame=function(){this.activeGame&&(this.tt.endState(),this.gm.endState(),this.endLoop(),this.activeGame=!1)},s.prototype.startLoop=function(){this.prev=window.performance.now(),this.loop(this.prev),this.activeGame=!0},s.prototype.endLoop=function(){cancelAnimationFrame(this.loopId),this.loopId=null},s.prototype.resetInputQueue=function(){this.moves.clear()},t.exports.Engine=s},function(t,i,e){var s=e(0).Engine;window.onload=function(){window.game=new s}},function(t,i){t.exports={keyMap:{LEFT:37,RIGHT:39,DOWN:40,DROP:32,RTURN:38,LTURN:90,NEW:78,PAUSE:80,QUIT:81},tetris:{pieceFreq:2,height:20,startLevel:5},containerId:"zone",lineColor:"#7986cb",fillColor:"#1a237e",borderColor:"#1a237e",borderWeight:8,lineWeight:1}},function(t,i){function e(){this.container,this.height,this.square,this.gridLeft,this.gridTop,this.nextLeft,this.nextTop,this.activeLeft,this.activeTop,this.canvas1,this.canvas2,this.canvas3,this.canvas4,this.ctx1,this.ctx2,this.ctx3,this.ctx4,this.borderWeight,this.borderColor,this.lineWeight,this.lineColor,this.fillColor}e.prototype.setConfig=function(t){this.container=document.getElementById(t.containerId),this.height=t.tetris.height,this.borderWeight=t.borderWeight,this.borderColor=t.borderColor,this.lineWeight=t.lineWeight,this.lineColor=t.lineColor,this.fillColor=t.fillColor},e.prototype.initialize=function(){this.container.style.padding="0px";var t=this.container.clientWidth*window.devicePixelRatio;this.square=t/24,this.gridLeft=7*this.square,this.gridTop=this.square,this.nextLeft=19*this.square,this.nextTop=this.square*(1+(Math.max(this.height,4)-4)/2),this.activeLeft=this.gridLeft-5*this.square,this.activeTop=this.gridTop-4*this.square,this.canvas1=document.createElement("canvas"),this.canvas2=document.createElement("canvas"),this.canvas3=document.createElement("canvas"),this.canvas4=document.createElement("canvas"),this.canvas1.width=this.canvas2.width=this.canvas3.width=this.canvas4.width=t,this.canvas1.height=this.canvas2.height=this.canvas3.height=this.canvas4.height=this.square*Math.max(this.height+2,6),this.canvas1.style.width=this.canvas2.style.width=this.canvas3.style.width=this.canvas4.style.width=this.canvas4.width/window.devicePixelRatio+"px",this.canvas1.style.height=this.canvas2.style.height=this.canvas3.style.height=this.canvas4.style.height=this.canvas4.height/window.devicePixelRatio+"px",this.canvas1.style.position=this.canvas2.style.position=this.canvas3.style.position=this.canvas4.style.position="absolute",this.canvas1.style.zIndex=1,this.canvas2.style.zIndex=2,this.canvas3.style.zIndex=3,this.canvas4.style.zIndex=4,this.container.appendChild(this.canvas1),this.container.appendChild(this.canvas2),this.container.appendChild(this.canvas3),this.container.appendChild(this.canvas4),this.ctx1=this.canvas1.getContext("2d"),this.ctx2=this.canvas2.getContext("2d"),this.ctx3=this.canvas3.getContext("2d"),this.ctx4=this.canvas4.getContext("2d"),this.drawGrid()},e.prototype.newState=function(){this.clearActive(),this.clearNext(),this.clearStatic(),this.clearScore()},e.prototype.endState=function(){this.drawGameOver()},e.prototype.render=function(t){t.active.dirty&&(this.clearActive(),this.drawActive(t.active.data.rotations[t.active.data.rIdx],t.active.data.j,t.active.data.i),t.active.dirty=!1),t.next.dirty&&(this.clearNext(),this.drawNext(t.next.data.rotations[t.next.data.rIdx]),t.next.dirty=!1),t.static.dirty&&(this.clearStatic(),this.drawStatic(t.static.data),t.static.dirty=!1),t.score.dirty&&(this.clearScore(),this.drawScore(t.score.data),t.score.dirty=!1)},e.prototype.clearActive=function(){this.clear(this.ctx1,this.gridLeft,this.gridTop,10*this.square,this.square*this.height)},e.prototype.clearNext=function(){this.clear(this.ctx2,this.nextLeft,this.nextTop,4*this.square,4*this.square)},e.prototype.clearStatic=function(){this.clear(this.ctx2,this.gridLeft,this.gridTop,10*this.square,this.square*this.height)},e.prototype.clearScore=function(){this.clear(this.ctx4,0,0,this.canvas4.width,this.canvas4.height)},e.prototype.clear=function(t,i,e,s,h){t.clearRect(i,e,s,h)},e.prototype.drawActive=function(t,i,e){this.ctx1.beginPath(),this.ctx1.fillStyle=this.fillColor;for(var s=32768,h=0;h<4;h++){var o=h+i;if(o<4)s>>>=4;else for(var r=0;r<4;r++){var a=r+e;a>4&&s&t&&this.ctx1.rect(this.activeLeft+this.square*a,this.activeTop+this.square*o,this.square,this.square),s>>>=1}}this.ctx1.fill()},e.prototype.drawNext=function(t){this.ctx2.beginPath(),this.ctx2.fillStyle=this.fillColor;for(var i=32768,e=0;e<4;e++)for(var s=0;s<4;s++)i&t&&this.ctx2.rect(this.nextLeft+this.square*s,this.nextTop+this.square*e,this.square,this.square),i>>>=1;this.ctx2.fill()},e.prototype.drawStatic=function(t){this.ctx2.beginPath(),this.ctx2.fillStyle=this.fillColor;for(var i=t.length-5;i>3;i--){if(2049==t[i])break;for(var e=1024,s=0;s<10;s++)e&t[i]&&this.ctx2.rect(this.gridLeft+this.square*s,this.gridTop+this.square*(i-4),this.square,this.square),e>>>=1}this.ctx2.fill()},e.prototype.drawScore=function(t){this.ctx4.beginPath(),this.ctx4.font="14px monospace",this.ctx4.textAlign="left",this.ctx4.fillStyle=this.borderColor,this.ctx4.textBaseline="top",this.ctx4.fillText("Score: "+t.score,this.nextLeft,this.nextTop+5*this.square,this.canvas4.width-this.nextLeft),this.ctx4.fillText("Lines: "+t.lines,this.nextLeft,this.nextTop+5*this.square+14*window.devicePixelRatio,this.canvas4.width-this.nextLeft),this.ctx4.fillText("Level: "+t.level,this.nextLeft,this.nextTop+5*this.square+28*window.devicePixelRatio,this.canvas4.width-this.nextLeft)},e.prototype.drawGrid=function(){this.ctx3.beginPath(),this.ctx3.strokeStyle=this.lineColor,this.ctx3.lineWidth=this.lineWeight;for(var t=0;t<this.height-1;t++)this.ctx3.moveTo(this.gridLeft,this.gridTop+this.square*(1+t)),this.ctx3.lineTo(this.gridLeft+10*this.square,this.gridTop+this.square*(1+t));for(var i=0;i<9;i++)this.ctx3.moveTo(this.gridLeft+this.square*(1+i),this.gridTop),this.ctx3.lineTo(this.gridLeft+this.square*(1+i),this.gridTop+this.square*this.height);for(var t=0;t<3;t++)this.ctx3.moveTo(this.nextLeft,this.nextTop+this.square*(1+t)),this.ctx3.lineTo(this.nextLeft+4*this.square,this.nextTop+this.square*(1+t));for(var i=0;i<3;i++)this.ctx3.moveTo(this.nextLeft+this.square*(1+i),this.nextTop),this.ctx3.lineTo(this.nextLeft+this.square*(1+i),this.nextTop+4*this.square);this.ctx3.stroke(),this.ctx3.strokeStyle=this.borderColor,this.ctx3.lineWidth=this.borderWeight,this.ctx3.strokeRect(this.gridLeft,this.gridTop,10*this.square,this.square*this.height),this.ctx3.strokeRect(this.nextLeft,this.nextTop,4*this.square,4*this.square)},e.prototype.drawGameOver=function(){this.ctx4.beginPath(),this.ctx4.font="60px monospace",this.ctx4.textAlign="center",this.ctx4.fillStyle="#b71c1c",this.ctx4.fillText("GAME OVER",this.canvas4.width/2,this.canvas4.height/2,10*this.square)},t.exports.GraphicsManager=e},function(t,i){function e(){this.km,this.notify,this.newGame,this.quitGame,this.pauseGame}e.prototype.setKeyMap=function(t){this.km=t},e.prototype.register=function(t,i){switch(t){case"action":this.notify=i;break;case"newgame":this.newGame=i;break;case"quitgame":this.quitGame=i;break;case"pausegame":this.pauseGame=i}},e.prototype.listen=function(){document.addEventListener("keydown",this.keyHandler.bind(this))},e.prototype.keyHandler=function(t){switch(t.keyCode){case this.km.LEFT:case this.km.RIGHT:case this.km.DOWN:case this.km.DROP:case this.km.RTURN:case this.km.LTURN:this.notify(t.keyCode),t.preventDefault();break;case this.km.NEW:this.newGame(),t.preventDefault();break;case this.km.QUIT:this.quitGame(),t.preventDefault();break;case this.km.PAUSE:this.pauseGame(),t.preventDefault()}},t.exports.InputManager=e},function(t,i){function e(t){this.buffer=new Int8Array(new ArrayBuffer(t)),this.read=0,this.write=0}e.prototype.push=function(t){this.write==this.buffer.length&&this.grow(),this.buffer[this.write++]=t},e.prototype.pop=function(){return 0==this.size()?void this.clear():this.buffer[this.read++]},e.prototype.peek=function(){if(0!=this.size())return this.buffer[this.read]},e.prototype.size=function(){return this.write-this.read},e.prototype.clear=function(){this.read=this.write=0},e.prototype.grow=function(){var t=this.buffer;this.buffer=new Int8Array(new ArrayBuffer(2*t.length));for(var i=0;this.read<this.write;)this.buffer[i++]=t[this.read++];this.read=0,this.write=i},t.exports.Queue=e},function(t,i){function e(t,i,e){this.autoReload=e,this.data=this.build(t,i),this.top=this.data.length-1,this.shuffle()}e.prototype.pop=function(){if(0==this.size()){if(!this.autoReload)return;this.shuffle()}return this.data[this.top--]},e.prototype.peek=function(){if(0==this.size()){if(!this.autoReload)return;this.shuffle()}return this.data[this.top]},e.prototype.shuffle=function(){for(var t=this.data.length-1;t>-1;t--){var i=Math.random()*(t+1)|0,e=this.data[t];this.data[t]=this.data[i],this.data[i]=e}this.top=this.data.length-1},e.prototype.size=function(){return this.top+1},e.prototype.build=function(t,i){for(var e=new Array(t.length*i),s=0;s<t.length;s++)for(var h=0;h<i;h++)e[i*s+h]=t[s];return e},t.exports.RandomSack=e},function(t,i,e){function s(){this.cf,this.km,this.accumulator,this.treshold,this.piece1,this.piece2,this.board,this.data,this.bag,this.gameOver,this.notifyEnd,this.score,this.totalLines,this.lines,this.minLines,this.level,this.levelSelect}var h=e(6).RandomSack;s.prototype.setConfig=function(t){this.cf=t.tetris,this.km=t.keyMap},s.prototype.register=function(t,i){switch(t){case"gameover":this.notifyEnd=i}},s.prototype.initialize=function(){this.piece1=new this.Piece(this.START_J,this.START_I),this.piece2=new this.Piece(this.START_J,this.START_I),this.bag=new h(this.SHAPES,this.cf.pieceFreq,!0),this.board=this.buildBoard(this.cf.height),this.data={active:{data:this.piece1,dirty:!1},next:{data:this.piece2,dirty:!1},static:{data:this.board,dirty:!1},score:{data:{score:0,lines:0,level:0},dirty:!1}},this.setupLevels()},s.prototype.newState=function(){this.gameOver=!1,this.accumulator=0,this.score=0,this.totalLines=0,this.lines=0,this.level=parseInt(this.levelSelect.value),this.minLines=this.getMinLines(this.level),this.data.score.data.score=this.score,this.data.score.data.lines=this.totalLines,this.data.score.data.level=this.level,this.data.score.dirty=!0,this.levelSelect.blur(),this.levelSelect.disabled=!0,this.resetBoard(),this.loadPieces(),this.resetDropPeriod()},s.prototype.endState=function(){this.gameOver=!0,this.levelSelect.disabled=!1},s.prototype.update=function(t,i){for(;!this.gameOver&&t.size()>0;)this.process(t.pop());for(this.accumulator=this.accumulator+i;!this.gameOver&&this.accumulator>this.threshold;)this.accumulator=this.accumulator-this.threshold,this.moveDown(this.piece1)},s.prototype.process=function(t){switch(t){case this.km.LEFT:this.moveLeft(this.piece1);break;case this.km.RIGHT:this.moveRight(this.piece1);break;case this.km.DOWN:this.moveDown(this.piece1);break;case this.km.DROP:this.drop();break;case this.km.RTURN:this.rotateR(this.piece1);break;case this.km.LTURN:this.rotateL(this.piece1)}},s.prototype.moveLeft=function(t){this.valid(t.j,t.i-1,t.rotations[t.rIdx],this.board)&&(t.i--,this.recordPiece1Update())},s.prototype.moveRight=function(t){this.valid(t.j,t.i+1,t.rotations[t.rIdx],this.board)&&(t.i++,this.recordPiece1Update())},s.prototype.moveDown=function(t){this.valid(t.j+1,t.i,t.rotations[t.rIdx],this.board)?(t.j++,this.recordPiece1Update()):(this.freeze(t,this.board),this.recordBoardUpdate(),this.checkForLines(this.board),this.loadPieces(),this.resetDropPeriod(),this.valid(t.j,t.i,t.rotations[t.rIdx],this.board)||this.notifyEnd())},s.prototype.drop=function(){this.threshold=2},s.prototype.rotateR=function(t){this.valid(t.j,t.i,t.rotations[t.getRight()],this.board)&&(t.rIdx=t.getRight(),this.recordPiece1Update())},s.prototype.rotateL=function(t){this.valid(t.j,t.i,t.rotations[t.getLeft()],this.board)&&(t.rIdx=t.getLeft(),this.recordPiece1Update())},s.prototype.valid=function(t,i,e,s){return!((61440&e)>>>i&s[t])&&(!((3840&e)<<4>>>i&s[t+1])&&(!((240&e)<<8>>>i&s[t+2])&&!((15&e)<<12>>>i&s[t+3])))},s.prototype.freeze=function(t,i){for(var e=61440,s=0;s<4;s++)i[t.j+s]|=(e&t.rotations[t.rIdx])<<4*s>>>t.i,e>>>=4},s.prototype.checkForLines=function(t){for(var i=0,e=this.board.length-5;e>-1&&2049!=t[e];e--)if(4095==t[e]){for(var s=e,h=e-1;h>-1;)t[s--]=t[h--];t[0]=2049,i++,e++}i>0&&this.updateScore(i)},s.prototype.updateScore=function(t){for(this.score+=this.scoring[t-1]*(this.level+1),this.totalLines+=t,this.lines+=t;this.lines>=this.minLines;)this.level++,this.lines-=this.minLines,this.minLines=10;this.recordScoreUpdate()},s.prototype.getMinLines=function(t){return Math.min(10*t+10,Math.max(100,10*t-50))},s.prototype.recordPiece1Update=function(){this.data.active.dirty=!0},s.prototype.recordPiece2Update=function(){this.data.next.dirty=!0},s.prototype.recordBoardUpdate=function(){this.data.static.dirty=!0},s.prototype.recordScoreUpdate=function(){this.data.score.data.score=this.score,this.data.score.data.lines=this.totalLines,this.data.score.data.level=this.level,this.data.score.dirty=!0},s.prototype.buildBoard=function(t){return new Int16Array(new ArrayBuffer(2*(t+8)))},s.prototype.resetBoard=function(){for(var t=0;t<this.board.length-4;t++)this.board[t]=2049;for(var t=this.board.length-4;t<this.board.length;t++)this.board[t]=4095},s.prototype.loadPieces=function(){this.piece2.rotations?this.piece1.rotations=this.piece2.rotations:this.piece1.rotations=this.bag.pop(),this.piece2.rotations=this.bag.pop(),this.piece1.j=this.START_J,this.piece1.i=this.START_I,this.piece1.rIdx=0,this.recordPiece1Update(),this.recordPiece2Update()},s.prototype.resetDropPeriod=function(){switch(!0){case this.level<8:this.threshold=(48-5*this.level)/60*1e3;break;case this.level<10:this.threshold=(8-2*(this.level-8))/60*1e3;break;case this.level<13:this.threshold=5/60*1e3;break;case this.level<16:this.threshold=4/60*1e3;break;case this.level<19:this.threshold=50;break;case this.level<29:this.threshold=2/60*1e3;break;default:this.threshold=1/60*1e3}},s.prototype.setupLevels=function(){this.levelSelect=document.getElementById("levels");for(var t=0;t<30;t++){var i=document.createElement("option");i.text="level: "+t,i.value=t,this.levelSelect.appendChild(i)}},s.prototype.SHAPES=[[240,8738,240,8738],[3616,17600,36352,25664],[3712,50240,11776,17504],[3648,19520,19968,17984],[1728,17952,1728,17952],[3168,9792,3168,9792],[1632,1632,1632,1632]],s.prototype.START_J=0,s.prototype.START_I=8,s.prototype.scoring=[40,100,300,1200],s.prototype.Piece=function(t,i){this.j=t,this.i=i,this.rIdx=0,this.rotations},s.prototype.Piece.prototype.getRight=function(){return this.rIdx==this.rotations.length-1?0:this.rIdx+1},s.prototype.Piece.prototype.getLeft=function(){return 0==this.rIdx?this.rotations.length-1:this.rIdx-1},t.exports.Tetris=s}]);</script></body></html>